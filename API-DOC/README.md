# 2ch makaba API

Большинство работы с makaba API осуществляется через JSON, обращениями по SSL протоколу.
Исключения, будут обговорены в каждом конкретном случае.

## Список досок

http://2ch.hk/makaba/mobile.fcgi?task=get_boards


## Получение списка тредов для доски

https://2ch.hk/board/page.json

**board** - код доски (b, soc и т.д.)

**page** - номер страницы

Максимальное количество страниц для каждой доски разное, этот парамтер передаётся в ответе на запрос списка досок вместе с названием и кратким кодом.
Если страница - начальная, то в PAGE стоит подставить ключевое слово **index**.


## Получение списка сообщений для треда

https://2ch.hk/board/res/thread_num.json

**board** - код доски (b, soc и т.д.)

**thread_num** - числовой номер сообщения ОП-поста треда (можно получить в списке тредов для доски).


## Отправка сообщения в тред / создание треда

https://2ch.hk/makaba/posting.fcgi

Параметры для передачи:

+ json = **1**
+ task = **post**
+ board - *код доски*
+ thread - *номер треда* - для создания нового треда необходимо проставить **0**
+ email - *значение поля e-mail*
+ name - *имя*
+ subject - *тема сообщения*
+ comment - *комментарий*, максимальное количество символов - *15000*
+ image - *изображение для отправки*

Если нет пасскода, то необходимо использовать капчу (см. раздел **Работа с 2ch Captcha**)

Если есть пасскод, необходимо поле:
+ usercode - подробно о том, что это такое описано в соответствующем разделе.

Параметр **usercode** и связка параметров для капчи являются взаимоисключающими.

При использовании их одновременно положительный ответ сервера не гарантирован.

Если используется что-то одно, то второе обязательно должно **отсутствовать** в запросе.


## Получение одного поста
https://2ch.hk/makaba/mobile.fcgi

Параметры для передачи:

+ task = **get_thread**
+ board - *код доски*
+ thread - *id треда*
+ num - *id поста*

## Работа с 2ch Captcha

1. Получение идентификатора для подписи сообщения: https://2ch.hk/api/captcha/app/id/*public_key*

2. Постинг: https://2ch.hk/api/captcha/
+ captcha_type = **app**
+ app_response_id - идентификатор полученный от запроса к капче на шаге 1
+ app_response - sha256(app_response_id + "|" + приватный ключ)


Ответ: Переменная result отвечает за результат выполнения запроса и может принимать следующие значения:
3 - Капча не требуется. Например, в случае если на доске она отключена.
2 - Капча не требуется, поскольку активен VIP аккаунт.
1 - Запрос удовлетворён успешно.
0 - При выполнении запроса возникла ошибка. Код ошибки находится в переменной error, описание ошибки в переменной description. В данный момент спецификация кодов ошибок находится в разработке и скорее всего будет изменена.

## Использование пасскода при работе с API

Работу по обеспечению рабочего механизма отправки сообщений через пасскод можно разделить на следующие этапы:

1) отправка пасскода на сервер двача

POST-запрос по адресу: https://2ch.hk/makaba/makaba.fcgi с параметрами:
  + task = **auth**
  + usercode = *passcode* - необходимо отправлять именно пасскод, и пусть вас не смущает название параметра

2) получение в ответ **usercode**-параметр для использования в дальнейших запросах

К сожалению, как такового ответа в нормальном виде сервер не выдаст. Вместо этого он сохранит локально Cookies на устройстве и попытается перенаправить на одну из досок (обычно b).

3) сохранение **usercode**-параметра как cookie

Нас интересует cookie с параметром name равным **usercode_nocaptcha**, необходимо самостоятельно достать его значение из кук (создаётся при отправке пасскода на устройстве автоматом) и сохранить локально на устройстве через соответствующий механизм.

Затем использовать этот параметр в форме как значение переменной **usercode**. а также создавать локальную cookie-переменную с именем ***usercode_nocaptcha** и значением, соответствующим значению, полученному с сервера.

4) использование usercode-параметра при отправке сообщений

**Внимание!**  Чтобы пользователю не приходилось каждый раз прокатывать пасскод через авторизатор макабы, необходимо при каждом запуске приложения запрашивать значение из локального хранилища и формировать именно **cookie** из этих данных. Иначе API макабы не распознает наличие **usercode**, хотя мы и будем передавать его в форме.
